<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Log 檔案瀏覽器</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }
    
    h1 {
      text-align: center;
      color: #4a5568;
      margin-bottom: 30px;
      font-size: 2.5rem;
      font-weight: 300;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    h2 {
      color: #2d3748;
      margin: 30px 0 15px 0;
      font-size: 1.5rem;
      border-left: 4px solid #667eea;
      padding-left: 15px;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 25px;
      align-items: center;
    }
    
    input[type="file"] {
      flex: 1;
      min-width: 200px;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    
    input[type="file"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    #search {
      flex: 1;
      min-width: 200px;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 25px;
      font-size: 14px;
      background: white;
      transition: all 0.3s ease;
    }
    
    #search:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    #logs, #mergedLogs {
      max-height: 500px;
      overflow: auto;
      border: none;
      padding: 20px;
      background: #f8fafc;
      margin-bottom: 25px;
      border-radius: 12px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
      border-left: 4px solid #667eea;
    }
    
    #logs::-webkit-scrollbar,
    #mergedLogs::-webkit-scrollbar {
      width: 8px;
    }
    
    #logs::-webkit-scrollbar-track,
    #mergedLogs::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    #logs::-webkit-scrollbar-thumb,
    #mergedLogs::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 4px;
    }
    
    #logs::-webkit-scrollbar-thumb:hover,
    #mergedLogs::-webkit-scrollbar-thumb:hover {
      background: #5a67d8;
    }
    
    pre {
      white-space: pre-wrap;
      word-break: break-all;
      margin: 0;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.5;
      color: #2d3748;
    }
    
    .log-block {
      margin-bottom: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
    }
    
    .highlight {
      background: linear-gradient(120deg, #ffd700, #ffed4e);
      padding: 2px 4px;
      border-radius: 3px;
      color: #2d3748;
      font-weight: 500;
    }
    
    .sticky-header {
      position: sticky;
      top: 0;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 12px 20px;
      z-index: 1;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .divider {
      border: none;
      height: 2px;
      background: linear-gradient(90deg, transparent, #667eea, transparent);
      margin: 40px 0;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
    }
    
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 20px;
      color: #cbd5e0;
    }
    
    /* 拖拉上傳區域 */
    .drop-zone {
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 20px;
      background: #f8fafc;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .drop-zone.dragover {
      border-color: #667eea;
      background: #e6fffa;
      transform: scale(1.02);
    }
    
    .drop-zone-text {
      color: #718096;
      font-size: 16px;
      margin-top: 10px;
    }
    
    .drop-zone-icon {
      font-size: 3rem;
      color: #cbd5e0;
      margin-bottom: 15px;
    }
    
    /* 檔案列表 */
    .file-list {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
    }
    
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .file-item:last-child {
      border-bottom: none;
    }
    
    .file-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .file-name {
      font-weight: 500;
      color: #2d3748;
    }
    
    .file-size {
      font-size: 12px;
      color: #718096;
    }
    
    .delete-btn {
      background: #fed7d7;
      color: #c53030;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .delete-btn:hover {
      background: #fc8181;
      color: white;
    }
    
    .clear-all-btn {
      background: #e53e3e;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-left: 10px;
    }
    
    .clear-all-btn:hover {
      background: #c53030;
    }
    
    /* 匯出控制樣式 */
    .export-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }
    
    .export-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .export-btn:hover {
      background: linear-gradient(135deg, #5a67d8, #6b46c1);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .export-btn:active {
      transform: translateY(0);
    }
    
    .export-btn:disabled {
      background: #e2e8f0;
      color: #a0aec0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .line-number-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #4a5568;
      cursor: pointer;
      user-select: none;
      margin-left: 10px;
      padding: 8px 12px;
      background: #f7fafc;
      border-radius: 6px;
      transition: background 0.2s ease;
    }
    
    .line-number-toggle:hover {
      background: #edf2f7;
    }
    
    .line-number-toggle input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #667eea;
      cursor: pointer;
    }
    
    /* 進階篩選樣式 */
    .advanced-filters {
      margin-bottom: 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
    }
    
    .filter-section {
      border: none;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .filter-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px 20px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.3s ease;
    }
    
    .filter-header:hover {
      background: linear-gradient(135deg, #5a67d8, #6b46c1);
    }
    
    .filter-content {
      padding: 20px;
    }
    
    .filter-group {
      margin-bottom: 20px;
    }
    
    .filter-group:last-child {
      margin-bottom: 0;
    }
    
    .filter-label {
      display: block;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    /* 日期範圍樣式 */
    .date-range {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .date-input {
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      transition: border-color 0.3s ease;
      flex: 1;
      min-width: 140px;
    }
    
    .date-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .date-separator {
      color: #718096;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .clear-date-btn {
      padding: 8px 16px;
      background: #f7fafc;
      color: #4a5568;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .clear-date-btn:hover {
      background: #edf2f7;
      border-color: #cbd5e0;
    }
    
    /* Log 等級過濾樣式 */
    .level-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .level-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #4a5568;
      font-weight: 500;
      user-select: none;
      transition: color 0.2s ease;
    }
    
    .level-checkbox:hover {
      color: #2d3748;
    }
    
    .level-checkbox input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #667eea;
      cursor: pointer;
    }
    
    /* 搜尋選項樣式 */
    .search-options {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .search-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #4a5568;
      font-weight: 500;
      user-select: none;
      transition: color 0.2s ease;
    }
    
    .search-option:hover {
      color: #2d3748;
    }
    
    .search-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #667eea;
      cursor: pointer;
    }
    
    /* 多關鍵字搜尋樣式 */
    .multi-keyword {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .multi-keyword-input {
      padding: 10px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      transition: border-color 0.3s ease;
    }
    
    .multi-keyword-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .logic-options {
      display: flex;
      gap: 20px;
    }
    
    .logic-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #4a5568;
      font-weight: 500;
      user-select: none;
      transition: color 0.2s ease;
    }
    
    .logic-option:hover {
      color: #2d3748;
    }
    
      .logic-option input[type="radio"] {
        width: 16px;
        height: 16px;
        accent-color: #667eea;
        cursor: pointer;
      }
      
      /* 合併日誌樣式 */
      .merged-log-item .log-source {
        background: #667eea;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        margin-right: 8px;
        display: inline-block;
      }
      
      .merged-log-item:nth-child(odd) .log-source {
        background: #764ba2;
      }
      
      .merged-log-item:nth-child(even) .log-source {
        background: #f093fb;
        color: #333;
      }
      
      /* 行號樣式 */
      .line-numbers {
        counter-reset: line-counter;
      }
      
      .line-numbers .log-line {
        counter-increment: line-counter;
        position: relative;
        padding-left: 4em;
        line-height: 1.5;
      }
      
      .line-numbers .log-line:before {
        content: counter(line-counter);
        position: absolute;
        left: 0;
        width: 3em;
        text-align: right;
        color: #a0aec0;
        font-size: 12px;
        border-right: 1px solid #e2e8f0;
        padding-right: 10px;
        margin-right: 10px;
        user-select: none;
      }
      
      .line-numbers .log-line:hover:before {
        color: #667eea;
        border-right-color: #667eea;
      }    /* 響應式設計 */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 20px;
        border-radius: 10px;
      }
      
      h1 {
        font-size: 2rem;
        margin-bottom: 20px;
      }
      
      h2 {
        font-size: 1.3rem;
      }
      
      .controls {
        flex-direction: column;
      }
      
      input[type="file"],
      #search {
        width: 100%;
        min-width: auto;
      }
      
      #logs, #mergedLogs {
        max-height: 300px;
        padding: 15px;
      }
      
      pre {
        font-size: 12px;
      }
      
      .sticky-header {
        padding: 10px 15px;
        font-size: 14px;
      }
      
      /* 進階篩選響應式 */
      .filter-content {
        padding: 15px;
      }
      
      .date-range {
        flex-direction: column;
        align-items: stretch;
      }
      
      .date-separator {
        text-align: center;
        margin: 5px 0;
      }
      
      .level-filters {
        flex-direction: column;
        gap: 10px;
      }
      
      .search-options {
        flex-direction: column;
        gap: 10px;
      }
      
      .logic-options {
        flex-direction: column;
        gap: 10px;
      }
      
      .filter-group {
        margin-bottom: 15px;
      }
      
      /* 匯出控制響應式 */
      .export-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      
      .export-btn {
        width: 100%;
        justify-content: center;
      }
      
      .line-number-toggle {
        margin-left: 0;
        justify-content: center;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 5px;
      }
      
      .container {
        padding: 15px;
        border-radius: 8px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      h2 {
        font-size: 1.2rem;
        padding-left: 10px;
      }
      
      #logs, #mergedLogs {
        max-height: 250px;
        padding: 10px;
      }
      
      pre {
        font-size: 11px;
      }
    }
    
    /* 動畫效果 */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .log-block {
      animation: fadeIn 0.3s ease-out;
    }
    
    /* 深色模式支援 */
    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
      }
      
      .container {
        background: rgba(45, 55, 72, 0.95);
        color: #e2e8f0;
      }
      
      h1, h2 {
        color: #e2e8f0;
      }
      
      input[type="file"],
      #search {
        background: #2d3748;
        border-color: #4a5568;
        color: #e2e8f0;
      }
      
      .drop-zone {
        background: #2d3748;
        border-color: #4a5568;
      }
      
      .drop-zone.dragover {
        border-color: #667eea;
        background: #1a202c;
      }
      
      .file-list {
        background: #2d3748;
        border-color: #4a5568;
      }
      
      .file-name {
        color: #e2e8f0;
      }
      
      #logs, #mergedLogs {
        background: #2d3748;
        color: #e2e8f0;
      }
      
      .log-block {
        background: #2d3748;
        border-color: #4a5568;
      }
      
      pre {
        color: #e2e8f0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📊 Log 檔案瀏覽器</h1>
    
    <!-- 拖拉上傳區域 -->
    <div class="drop-zone" id="dropZone">
      <div class="drop-zone-icon">📁</div>
      <div class="drop-zone-text">
        <strong>拖拉檔案到此處</strong><br>
        或點擊下方按鈕選擇檔案
      </div>
    </div>
    
    <div class="controls">
      <input type="file" id="logFiles" multiple accept=".log,.txt" placeholder="選擇 Log 檔案">
      <input type="text" id="search" placeholder="🔍 搜尋關鍵字...">
      <button class="clear-all-btn" id="clearAllBtn" style="display: none;">🗑️ 清除全部</button>
      
      <!-- 匯出功能按鈕 -->
      <div class="export-controls" id="exportControls" style="display: none;">
        <button class="export-btn" id="exportFilteredBtn" title="匯出過濾後的搜尋結果">💾 匯出搜尋結果</button>
        <button class="export-btn" id="exportMergedBtn" title="匯出合併的時間排序結果">🔄 匯出合併檔案</button>
        <label class="line-number-toggle">
          <input type="checkbox" id="showLineNumbers"> 顯示行號
        </label>
      </div>
    </div>
    
    <!-- 進階篩選控制區 -->
    <div class="advanced-filters">
      <details class="filter-section">
        <summary class="filter-header">🔍 進階篩選選項</summary>
        <div class="filter-content">
          <!-- 日期範圍過濾 -->
          <div class="filter-group">
            <label class="filter-label">📅 日期範圍</label>
            <div class="date-range">
              <input type="date" id="startDate" class="date-input" placeholder="開始日期">
              <span class="date-separator">至</span>
              <input type="date" id="endDate" class="date-input" placeholder="結束日期">
              <button class="clear-date-btn" id="clearDateBtn">清除</button>
            </div>
          </div>
          
          <!-- Log 等級過濾 -->
          <div class="filter-group">
            <label class="filter-label">📊 Log 等級</label>
            <div class="level-filters">
              <label class="level-checkbox"><input type="checkbox" id="errorLevel" checked> ERROR</label>
              <label class="level-checkbox"><input type="checkbox" id="warnLevel" checked> WARN</label>
              <label class="level-checkbox"><input type="checkbox" id="infoLevel" checked> INFO</label>
              <label class="level-checkbox"><input type="checkbox" id="debugLevel" checked> DEBUG</label>
              <label class="level-checkbox"><input type="checkbox" id="traceLevel" checked> TRACE</label>
            </div>
          </div>
          
          <!-- 搜尋選項 -->
          <div class="filter-group">
            <label class="filter-label">🔍 搜尋選項</label>
            <div class="search-options">
              <label class="search-option">
                <input type="checkbox" id="regexSearch"> 正則表達式
              </label>
              <label class="search-option">
                <input type="checkbox" id="caseSensitive"> 大小寫敏感
              </label>
            </div>
          </div>
          
          <!-- 多關鍵字搜尋 -->
          <div class="filter-group">
            <label class="filter-label">🔗 多關鍵字搜尋</label>
            <div class="multi-keyword">
              <input type="text" id="multiKeywords" placeholder="關鍵字1,關鍵字2 或 關鍵字1|關鍵字2" class="multi-keyword-input">
              <div class="logic-options">
                <label class="logic-option">
                  <input type="radio" name="searchLogic" value="and" checked> AND (,)
                </label>
                <label class="logic-option">
                  <input type="radio" name="searchLogic" value="or"> OR (|)
                </label>
              </div>
            </div>
          </div>
        </div>
      </details>
    </div>
    
    <!-- 檔案列表 -->
    <div class="file-list" id="fileList" style="display: none;">
      <h3 style="margin-top: 0; color: #4a5568;">📋 已載入的檔案</h3>
      <div id="fileItems"></div>
    </div>
    
    <div id="logs">
      <div class="empty-state">
        <div style="font-size: 4rem; margin-bottom: 20px;">📁</div>
        <p>請選擇一個或多個 Log 檔案開始瀏覽</p>
      </div>
    </div>
    
    <hr class="divider">
    
    <h2>⏰ 合併依時間排序顯示</h2>
    <div id="mergedLogs">
      <div class="empty-state">
        <div style="font-size: 4rem; margin-bottom: 20px;">⏱️</div>
        <p>載入檔案後，這裡會顯示按時間排序的合併結果</p>
      </div>
    </div>
  </div>

  <script>
    const logFilesInput = document.getElementById('logFiles');
    const logsDiv = document.getElementById('logs');
    const mergedLogsDiv = document.getElementById('mergedLogs');
    const searchInput = document.getElementById('search');
    const dropZone = document.getElementById('dropZone');
    const fileList = document.getElementById('fileList');
    const fileItems = document.getElementById('fileItems');
    const clearAllBtn = document.getElementById('clearAllBtn');
    
    // 新增篩選控制元素
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const clearDateBtn = document.getElementById('clearDateBtn');
    const errorLevelCb = document.getElementById('errorLevel');
    const warnLevelCb = document.getElementById('warnLevel');
    const infoLevelCb = document.getElementById('infoLevel');
    const debugLevelCb = document.getElementById('debugLevel');
    const traceLevelCb = document.getElementById('traceLevel');
    const regexSearchCb = document.getElementById('regexSearch');
    const caseSensitiveCb = document.getElementById('caseSensitive');
    const multiKeywordsInput = document.getElementById('multiKeywords');
    const searchLogicRadios = document.querySelectorAll('input[name="searchLogic"]');
    
    // 新增匯出和行號控制元素
    const exportControls = document.getElementById('exportControls');
    const exportFilteredBtn = document.getElementById('exportFilteredBtn');
    const exportMergedBtn = document.getElementById('exportMergedBtn');
    const showLineNumbersCb = document.getElementById('showLineNumbers');
    
    let logContents = [];

    // 拖拉上傳功能
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files).filter(file => 
        file.name.endsWith('.log') || file.name.endsWith('.txt')
      );
      if (files.length > 0) {
        processFiles(files);
      }
    });

    // 點擊拖拉區域觸發檔案選擇
    dropZone.addEventListener('click', () => {
      logFilesInput.click();
    });

    // 檔案選擇事件
    logFilesInput.addEventListener('change', function(event) {
      const files = Array.from(event.target.files);
      if (files.length > 0) {
        processFiles(files);
      }
    });

    // 搜尋功能
    searchInput.addEventListener('input', () => {
      displayLogs();
      displayMergedLogs();
    });

    // 清除全部按鈕
    clearAllBtn.addEventListener('click', () => {
      if (confirm('確定要清除所有檔案嗎？')) {
        logContents = [];
        updateFileList();
        displayLogs();
        displayMergedLogs();
        logFilesInput.value = '';
        
        // 清除所有篩選條件
        searchInput.value = '';
        multiKeywordsInput.value = '';
        startDateInput.value = '';
        endDateInput.value = '';
        errorLevelCb.checked = true;
        warnLevelCb.checked = true;
        infoLevelCb.checked = true;
        debugLevelCb.checked = true;
        traceLevelCb.checked = true;
        regexSearchCb.checked = false;
        caseSensitiveCb.checked = false;
        showLineNumbersCb.checked = false;
        document.querySelector('input[name="searchLogic"][value="and"]').checked = true;
      }
    });

    // 處理檔案
    function processFiles(files) {
      files.forEach(file => {
        // 檢查是否已存在相同檔案名
        const existingIndex = logContents.findIndex(log => log.name === file.name);
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const logData = {
            name: file.name,
            content: e.target.result,
            size: file.size,
            id: Date.now() + Math.random() // 唯一ID
          };
          
          if (existingIndex >= 0) {
            // 替換現有檔案
            logContents[existingIndex] = logData;
          } else {
            // 新增檔案
            logContents.push(logData);
          }
          
          updateFileList();
          displayLogs();
          displayMergedLogs();
        };
        reader.readAsText(file);
      });
    }

    // 更新檔案列表
    function updateFileList() {
      if (logContents.length === 0) {
        fileList.style.display = 'none';
        clearAllBtn.style.display = 'none';
        exportControls.style.display = 'none';
        return;
      }

      fileList.style.display = 'block';
      clearAllBtn.style.display = 'inline-block';
      exportControls.style.display = 'flex';
      
      fileItems.innerHTML = logContents.map(log => `
        <div class="file-item">
          <div class="file-info">
            <span class="file-name">📄 ${log.name}</span>
            <span class="file-size">(${formatFileSize(log.size)})</span>
          </div>
          <button class="delete-btn" onclick="removeFile('${log.id}')">🗑️ 刪除</button>
        </div>
      `).join('');
    }

    // 刪除單一檔案
    function removeFile(fileId) {
      logContents = logContents.filter(log => log.id != fileId);
      updateFileList();
      displayLogs();
      displayMergedLogs();
    }

    // 格式化檔案大小
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function highlightKeyword(text, keyword) {
      if (!keyword) return text;
      // 避免 XSS
      const safeText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      return safeText.replace(new RegExp(keyword, 'gi'), match => `<span class="highlight">${match}</span>`);
    }

    // 解析日期函數 - 支援多種格式
    function parseLogDate(line) {
      // 常見的日期格式
      const datePatterns = [
        /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})/,  // 2024-01-15 10:30:45,123
        /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3})/,  // 2024-01-15 10:30:45.123
        /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/,         // 2024-01-15 10:30:45
        /(\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2})/,       // 2024/01/15 10:30:45
        /(\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2})/,       // 15/01/2024 10:30:45
      ];
      
      for (const pattern of datePatterns) {
        const match = line.match(pattern);
        if (match) {
          return new Date(match[1].replace(',', '.'));
        }
      }
      return null;
    }

    // 檢查日期是否在指定範圍內
    function isDateInRange(logDate, startDate, endDate) {
      if (!logDate) return !startDate && !endDate;
      
      const logTime = logDate.getTime();
      
      if (startDate && logTime < startDate.getTime()) return false;
      if (endDate && logTime > endDate.getTime() + 86400000) return false; // 加一天，包含結束日期整天
      
      return true;
    }

    // 檢查 log 等級
    function getLogLevel(line) {
      const levelPatterns = {
        'ERROR': /ERROR|FATAL|SEVERE/i,
        'WARN': /WARN|WARNING/i,
        'INFO': /INFO/i,
        'DEBUG': /DEBUG/i,
        'TRACE': /TRACE|VERBOSE/i
      };
      
      for (const [level, pattern] of Object.entries(levelPatterns)) {
        if (pattern.test(line)) return level;
      }
      return 'INFO'; // 預設等級
    }

    // 檢查 log 等級是否被選中
    function isLevelSelected(level) {
      switch (level) {
        case 'ERROR': return errorLevelCb.checked;
        case 'WARN': return warnLevelCb.checked;
        case 'INFO': return infoLevelCb.checked;
        case 'DEBUG': return debugLevelCb.checked;
        case 'TRACE': return traceLevelCb.checked;
        default: return true;
      }
    }

    // 執行搜尋匹配
    function matchesSearch(line, searchText, useRegex, caseSensitive) {
      if (!searchText) return true;
      
      try {
        if (useRegex) {
          const flags = caseSensitive ? 'g' : 'gi';
          const regex = new RegExp(searchText, flags);
          return regex.test(line);
        } else {
          const text = caseSensitive ? line : line.toLowerCase();
          const search = caseSensitive ? searchText : searchText.toLowerCase();
          return text.includes(search);
        }
      } catch (e) {
        // 如果正則表達式無效，回退到普通搜尋
        const text = caseSensitive ? line : line.toLowerCase();
        const search = caseSensitive ? searchText : searchText.toLowerCase();
        return text.includes(search);
      }
    }

    // 多關鍵字搜尋
    function matchesMultiKeywords(line, keywords, logic, useRegex, caseSensitive) {
      if (!keywords) return true;
      
      const keywordList = logic === 'and' ? 
        keywords.split(',').map(k => k.trim()).filter(k => k) :
        keywords.split('|').map(k => k.trim()).filter(k => k);
      
      if (keywordList.length === 0) return true;
      
      if (logic === 'and') {
        return keywordList.every(keyword => 
          matchesSearch(line, keyword, useRegex, caseSensitive)
        );
      } else {
        return keywordList.some(keyword => 
          matchesSearch(line, keyword, useRegex, caseSensitive)
        );
      }
    }

    // 篩選單行 log
    function filterLogLine(line, options) {
      const {
        searchText,
        multiKeywords,
        searchLogic,
        useRegex,
        caseSensitive,
        startDate,
        endDate
      } = options;
      
      // 日期過濾
      const logDate = parseLogDate(line);
      if (!isDateInRange(logDate, startDate, endDate)) {
        return false;
      }
      
      // Log 等級過濾
      const level = getLogLevel(line);
      if (!isLevelSelected(level)) {
        return false;
      }
      
      // 搜尋過濾
      if (multiKeywords) {
        if (!matchesMultiKeywords(line, multiKeywords, searchLogic, useRegex, caseSensitive)) {
          return false;
        }
      } else if (searchText) {
        if (!matchesSearch(line, searchText, useRegex, caseSensitive)) {
          return false;
        }
      }
      
      return true;
    }

    // 獲取當前篩選選項
    function getFilterOptions() {
      const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
      const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
      const searchLogic = document.querySelector('input[name="searchLogic"]:checked').value;
      
      return {
        searchText: searchInput.value.trim(),
        multiKeywords: multiKeywordsInput.value.trim(),
        searchLogic,
        useRegex: regexSearchCb.checked,
        caseSensitive: caseSensitiveCb.checked,
        startDate,
        endDate
      };
    }

    // 檔案下載功能
    function downloadFile(content, filename, contentType = 'text/plain') {
      const blob = new Blob([content], { type: contentType });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    }

    // 格式化日期用於檔案名稱
    function formatDateForFilename(date = new Date()) {
      return date.toISOString().replace(/[:.]/g, '-').slice(0, 19);
    }

    // 移除 HTML 標籤
    function stripHtmlTags(str) {
      return str.replace(/<[^>]*>/g, '');
    }

    // 匯出過濾後的搜尋結果
    function exportFilteredResults() {
      const options = getFilterOptions();
      let exportContent = '';
      let totalLines = 0;
      
      // 生成檔案標頭
      const timestamp = new Date().toLocaleString('zh-TW');
      exportContent += `# 過濾搜尋結果匯出\n`;
      exportContent += `# 匯出時間: ${timestamp}\n`;
      exportContent += `# 原始檔案數量: ${logContents.length}\n`;
      
      // 添加篩選條件資訊
      if (options.searchText || options.multiKeywords) {
        exportContent += `# 搜尋條件: ${options.multiKeywords || options.searchText}\n`;
      }
      if (options.startDate || options.endDate) {
        exportContent += `# 日期範圍: ${options.startDate ? options.startDate.toLocaleDateString('zh-TW') : '不限'} 至 ${options.endDate ? options.endDate.toLocaleDateString('zh-TW') : '不限'}\n`;
      }
      exportContent += `\n`;
      
      logContents.forEach((log, logIndex) => {
        let lines = log.content.split('\n').filter(line => line.trim() !== '');
        let filteredLines = lines.filter(line => filterLogLine(line, options));
        
        if (filteredLines.length > 0) {
          exportContent += `========== 檔案: ${log.name} (${filteredLines.length}/${lines.length} 行) ==========\n`;
          filteredLines.forEach((line, lineIndex) => {
            totalLines++;
            const cleanLine = stripHtmlTags(line);
            exportContent += `${cleanLine}\n`;
          });
          exportContent += `\n`;
        }
      });
      
      exportContent += `\n# 總匯出行數: ${totalLines}\n`;
      
      if (totalLines === 0) {
        alert('沒有符合篩選條件的記錄可匯出！');
        return;
      }
      
      const filename = `filtered_logs_${formatDateForFilename()}.log`;
      downloadFile(exportContent, filename);
      
      alert(`已成功匯出 ${totalLines} 行記錄至 ${filename}`);
    }

    // 匯出合併檔案
    function exportMergedLogs() {
      const options = getFilterOptions();
      let allLines = [];
      
      logContents.forEach(log => {
        log.content.split('\n').forEach(line => {
          if (line.trim() === '') return;
          if (!filterLogLine(line, options)) return;
          
          const logDate = parseLogDate(line);
          allLines.push({ 
            time: logDate ? logDate.getTime() : 0, 
            line: stripHtmlTags(line), 
            file: log.name,
            dateString: logDate ? logDate.toISOString() : null
          });
        });
      });
      
      // 依時間排序
      allLines.sort((a, b) => {
        if (a.time === 0 && b.time === 0) return 0;
        if (a.time === 0) return 1;
        if (b.time === 0) return -1;
        return a.time - b.time;
      });
      
      if (allLines.length === 0) {
        alert('沒有符合篩選條件的記錄可匯出！');
        return;
      }
      
      // 生成匯出內容
      const timestamp = new Date().toLocaleString('zh-TW');
      let exportContent = `# 合併時間排序結果匯出\n`;
      exportContent += `# 匯出時間: ${timestamp}\n`;
      exportContent += `# 合併檔案數量: ${logContents.length}\n`;
      exportContent += `# 檔案列表: ${logContents.map(log => log.name).join(', ')}\n`;
      
      // 添加篩選條件資訊
      if (options.searchText || options.multiKeywords) {
        exportContent += `# 搜尋條件: ${options.multiKeywords || options.searchText}\n`;
      }
      if (options.startDate || options.endDate) {
        exportContent += `# 日期範圍: ${options.startDate ? options.startDate.toLocaleDateString('zh-TW') : '不限'} 至 ${options.endDate ? options.endDate.toLocaleDateString('zh-TW') : '不限'}\n`;
      }
      exportContent += `# 總行數: ${allLines.length}\n\n`;
      
      allLines.forEach((item, index) => {
        exportContent += `[${item.file}] ${item.line}\n`;
      });
      
      const filename = `merged_logs_${formatDateForFilename()}.log`;
      downloadFile(exportContent, filename);
      
      alert(`已成功匯出 ${allLines.length} 行合併記錄至 ${filename}`);
    }

    function displayLogs() {
      const options = getFilterOptions();
      const displayKeyword = options.multiKeywords || options.searchText;
      const showLineNumbers = showLineNumbersCb.checked;
      
      if (logContents.length === 0) {
        logsDiv.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 4rem; margin-bottom: 20px;">📁</div>
            <p>請選擇一個或多個 Log 檔案開始瀏覽</p>
          </div>
        `;
        return;
      }
      
      logsDiv.innerHTML = '';
      let totalFilteredLines = 0;
      
      logContents.forEach(log => {
        let lines = log.content.split('\n').filter(line => line.trim() !== '');
        let filteredLines = lines.filter(line => filterLogLine(line, options));
        
        totalFilteredLines += filteredLines.length;
        
        const logBlock = document.createElement('div');
        logBlock.className = 'log-block';
        
        const headerContent = filteredLines.length !== lines.length ? 
          `📄 ${log.name} (${filteredLines.length}/${lines.length} 行)` :
          `📄 ${log.name} (${lines.length} 行)`;
        
        let contentHTML = '';
        if (filteredLines.length > 0) {
          if (showLineNumbers) {
            contentHTML = filteredLines
              .map(line => `<div class="log-line">${highlightKeyword(line, displayKeyword)}</div>`)
              .join('');
            contentHTML = `<div class="line-numbers">${contentHTML}</div>`;
          } else {
            contentHTML = filteredLines
              .map(line => highlightKeyword(line, displayKeyword))
              .join('\n');
          }
        } else {
          contentHTML = '<div style="color: #999; font-style: italic;">沒有符合篩選條件的記錄</div>';
        }
        
        logBlock.innerHTML = `
          <div class="sticky-header">${headerContent}</div>
          <pre style="padding: 15px;">${contentHTML}</pre>
        `;
        logsDiv.appendChild(logBlock);
      });
      
      // 如果沒有任何符合條件的記錄
      if (totalFilteredLines === 0) {
        logsDiv.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 3rem; margin-bottom: 15px;">🔍</div>
            <p>沒有找到符合篩選條件的記錄</p>
            <p style="font-size: 0.9em; color: #666;">請嘗試調整篩選條件</p>
          </div>
        `;
      }
    }

    function displayMergedLogs() {
      const options = getFilterOptions();
      const displayKeyword = options.multiKeywords || options.searchText;
      const showLineNumbers = showLineNumbersCb.checked;
      
      if (logContents.length === 0) {
        mergedLogsDiv.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 4rem; margin-bottom: 20px;">⏱️</div>
            <p>載入檔案後，這裡會顯示按時間排序的合併結果</p>
          </div>
        `;
        return;
      }
      
      let allLines = [];
      logContents.forEach(log => {
        log.content.split('\n').forEach(line => {
          if (line.trim() === '') return;
          if (!filterLogLine(line, options)) return;
          
          const logDate = parseLogDate(line);
          allLines.push({ 
            time: logDate ? logDate.getTime() : 0, 
            line, 
            file: log.name,
            dateString: logDate ? logDate.toISOString() : null
          });
        });
      });
      
      // 依時間排序
      allLines.sort((a, b) => {
        if (a.time === 0 && b.time === 0) return 0;
        if (a.time === 0) return 1;
        if (b.time === 0) return -1;
        return a.time - b.time;
      });
      
      if (allLines.length === 0) {
        mergedLogsDiv.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 3rem; margin-bottom: 15px;">🔍</div>
            <p>沒有找到符合篩選條件的記錄</p>
            <p style="font-size: 0.9em; color: #666;">請嘗試調整篩選條件</p>
          </div>
        `;
        return;
      }
      
      let mergedContent = '';
      if (showLineNumbers) {
        mergedContent = allLines.map(l => {
          const sourceTag = `<span class="merged-log-item"><span class="log-source">${l.file}</span></span>`;
          return `<div class="log-line">${sourceTag} ${highlightKeyword(l.line, displayKeyword)}</div>`;
        }).join('');
        mergedContent = `<div class="line-numbers">${mergedContent}</div>`;
      } else {
        mergedContent = allLines.map(l => {
          const sourceTag = `<span class="merged-log-item"><span class="log-source">${l.file}</span></span>`;
          return `${sourceTag} ${highlightKeyword(l.line, displayKeyword)}`;
        }).join('\n');
      }
      
      mergedLogsDiv.innerHTML = `
        <div class="sticky-header">📊 合併結果 (${allLines.length} 行)</div>
        <pre style="padding: 15px;">${mergedContent}</pre>
      `;
    }

    // 進階篩選事件監聽器
    function addFilterEventListeners() {
      // 日期範圍篩選
      startDateInput.addEventListener('change', () => {
        displayLogs();
        displayMergedLogs();
      });
      
      endDateInput.addEventListener('change', () => {
        displayLogs();
        displayMergedLogs();
      });
      
      // 清除日期按鈕
      clearDateBtn.addEventListener('click', () => {
        startDateInput.value = '';
        endDateInput.value = '';
        displayLogs();
        displayMergedLogs();
      });
      
      // Log 等級篩選
      [errorLevelCb, warnLevelCb, infoLevelCb, debugLevelCb, traceLevelCb].forEach(cb => {
        cb.addEventListener('change', () => {
          displayLogs();
          displayMergedLogs();
        });
      });
      
      // 搜尋選項
      regexSearchCb.addEventListener('change', () => {
        displayLogs();
        displayMergedLogs();
      });
      
      caseSensitiveCb.addEventListener('change', () => {
        displayLogs();
        displayMergedLogs();
      });
      
      // 多關鍵字搜尋
      multiKeywordsInput.addEventListener('input', () => {
        if (multiKeywordsInput.value.trim()) {
          searchInput.value = ''; // 清除單一搜尋框
        }
        displayLogs();
        displayMergedLogs();
      });
      
      // 搜尋邏輯選項
      searchLogicRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          displayLogs();
          displayMergedLogs();
        });
      });
      
      // 行號顯示切換
      showLineNumbersCb.addEventListener('change', () => {
        displayLogs();
        displayMergedLogs();
      });
      
      // 匯出按鈕事件
      exportFilteredBtn.addEventListener('click', exportFilteredResults);
      exportMergedBtn.addEventListener('click', exportMergedLogs);
    }

    // 更新原有的搜尋事件監聽器
    searchInput.removeEventListener('input', () => {
      displayLogs();
      displayMergedLogs();
    });
    
    searchInput.addEventListener('input', () => {
      if (searchInput.value.trim()) {
        multiKeywordsInput.value = ''; // 清除多關鍵字搜尋框
      }
      displayLogs();
      displayMergedLogs();
    });

    // 初始化事件監聽器
    addFilterEventListeners();
  </script>
</body>
</html>